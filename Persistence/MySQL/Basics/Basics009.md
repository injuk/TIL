# Basics
## 2022-09-24 Sat

### 옵티마이저란?
```
> 어떠한 DBMS든지 쿼리의 실행 계획을 수립하고 결정하는 옵티마이저는 가장 복잡한 부분이며, 결과로 생성되는 실행 계획 역시 이해하기 상당히 어려운 축에 속한다.
```
* MySQL 서버로 요청되는 쿼리는 결과가 동일하지만, 내부적으로 결과를 만들어내는 작업은 매우 다양하다.
  * 이 때, 이러한 **다양한 방법 중 어떠한 방법이 최적이며 최소의 비용을 소모하는지 결정할 수 있어야 한다**.
* **대부분의 DBMS는 여러 기본 데이터를 비교하여 최적의 실행 계획을 수립하는 작업을 수행하며, 이러한 기능을 담당하는 것이 옵티마이저**가 된다.
  * 기본 데이터의 예로, MySQL은 쿼리를 최적으로 실행하기 위해 각 테이블의 데이터가 어떻게 분포되어 저장되어 있는지에 대한 통계 정보를 사용한다.

### 쿼리의 실행 절차
* MySQL 서버에서 쿼리가 실행되기까지의 과정은 크게 다음과 같이 분류된다.
  1. 요청된 **SQL 문장을 필요한만큼 쪼개어 MySQL 서버가 이해할 수 있는 수준으로 분리하고, 결과로 파스 트리를 생성**한다.
  2. **파스 트리를 확인하며 어떠한 테이블로부터 어떠한 인덱스를 활용하여 읽어들인지 선택**한다.
  3. 2.의 과정에서 **결정된 테이블의 읽기 순서 또는 선택된 인덱스를 활용하여 스토리지 엔진으로부터 데이터를 가져온다**. 
* 첫 단계는 **SQL 파싱이라고도 지칭하며, MySQL 서버는 SQL 파서라는 이름의 모듈로 SQL 파스 트리를 생성**한다.
  * 이 과정에서 **SQL 문장의 문법 오류가 검증되며, 이후 MySQL 서버는 원본 SQL 문이 아닌 SQL 파스 트리를 활용하여 쿼리를 실행**한다.
* 두 번째 단계는 **최적화 및 실행 계획 수립 단계라고도 지칭하며, 파싱 단계에서 생성된 파스 트리를 참조하며 다음과 같은 내용을 처리**한다.
  1. 불필요한 조건 제거 및 복잡한 연산을 단순화
  2. 여러 테이블이 조인되는 경우, 어떠한 순서로 테이블을 읽어들일지 결정
  3. 각각의 테이블에 사용된 조건과 인덱스 통계 정보를 활용하여 사용할 인덱스를 결정
  4. 가져온 레코드들을 임시 테이블에 삽입한 후 다시 한 번 가공해야할지 여부를 결정
  5. 이외의 수많은 처리들
* 이 때 **두 번째 단계는 MySQL 서버의 옵티마이저에서 처리되며, 완료시 그 결과로 실행 계획이 만들어지게 된다**. 
* 세 번째 단계에서는 **옵티마이저에 의해 수립된 실행 계획을 토대로 스토리지 엔진으로부터 레코드 조회를 요청**한다.
  * **MySQL 엔진에서는 스토리지 엔진으로부터 전달 받은 레코드를 조인하거나 정렬하는 작업을 수행**한다.
* 이 때, **파싱과 최적화 및 실행 계획 수립 단계는 대부분 MySQL 엔진에서 처리되는 반면 세 번째 단계는 MySQL 엔진과 스토리지 엔진이 함께 처리**한다.