# DomainDrivenDesign
## 2022-05-02 Mon

## 데이터 무결성
## 무결성이란?
* **무결성이란 서로 모순이 없고 일관적인 상태를 뜻하며, 시스템의 처리 중에는 데이터의 무결성을 필요로 하는 것이 존재**한다.
* 데이터의 무결성은 도메인 주도 설계와 직접적인 관련이 있는 주제는 아니지만, 소프트웨어를 작성하는 경우에는 반드시 유지되어야 하는 항목이다.

## 버그 시나리오
* 사용자 등록을 처리하는 애플리케이션 서비스를 예로 들어, 사용자 명의 중복을 허용하지 않는 경우를 가정한다.
  * 이 경우, 동시에 동일한 이름의 사용자가 등록을 시도하는 경우 중복 이름을 처리하지 못하는 순간이 발생할 수도 있다.
  * **한 명씩 사용자 등록을 시도하는 경우에는 버그가 발생하지 않을 수 있으나, 웹 애플리케이션에서 한 번에 한 명씩만 시스템을 사용한다는 것은 불가능**하다.
  * 때문에, 데이터의 무결성을 유지하기 위한 방안을 강구해야 할 필요가 있다.

### 방안 1. 데이터베이스의 유일 키 제약 기능 사용
* 유일 키 제약은 데이터베이스의 특정한 컬럼 값이 유일한 값이 되도록 보장하는 기능이며, 데이터의 무결성 유지에 매우 편리한 기능이다.
* 유일 키 제약을 사용하는 경우, 사용자 등록시 중복을 확인할 필요도 없으므로 코드의 양이 짧아지는 이점이 있다.
* 반면, **유일 키 제약 방식은 코드에서 사용자 명의 중복을 허용하지 않는다는 도메인 규칙을 읽어낼 수 없다는 단점이 존재**한다.
  * 숙련된 개발자라도 코드 자체에 드러나지 않는 도메인 규칙을 알아낼 방법은 없다.
* 또한, **유일 키 제약 방식은 비즈니스 로직이 임의의 데이터베이스의 기술에 의존하는 단점 또한 존재**한다.
  * **높은 추상화 수준을 갖는 비즈니스 로직은 낮은 추상화 수준을 갖는 데이터베이스의 기술에 의존하지 않아야 한다**.
* 즉, 데이터베이스가 제공하는 유일 키 제약에 의존하는 형태는 중요한 도메인 규칙과 관련된 처리가 원래 있어야 할 자리를 이탈하는 결과를 낳는다.
* **이상적인 것은 코드 상에서도 도메인 규칙과 관련된 처리를 수행하되, 유일 키 제약은 개발자의 실수에서 비롯된 버그를 방지하는 안전망으로 사용하는 것**이다. 

### 방안 2. 트랜잭션의 사용
* 데이터의 무결성을 유지하기 위한 수단으로 더 일반적인 것은 데이터베이스가 제공하는 트랜잭션 기능이다.
* **트랜잭션이란, 서로 의존적인 조작을 한 번에 완료하거나 롤백하는 방법을 통해 데이터의 무결성을 유지**한다.
  * **트랜잭션 기능이 적용되는 도중에는 데이터베이스에 대한 조작이 데이터에 바로 반영되지 않으며, 데이터에 반영하려면 반드시 커밋이 필요**하다.
* 그러나 트랜잭션 역시 데이터베이스가 제공하는 기술에 해당하므로, 유일 키 제약과 동일한 단점이 수반된다.
* 반면, 데이터 무결성 자체는 특정한 기술에 종속될 정도로 추상화 수준이 낮은 개념이 아니다.
  * 비즈니스 로직 관점에서는 반드시 데이터 무결성을 필요로 하지만, 그 수단이 무엇인지는 중요하지 않다.
  * 때문에 **비즈니스 로직에는 무결성을 위해 특정 기술에 의존하는 코드보다는 어느 범위에서 무결성이 확보되어야하는지 명시하는 코드가 포함되어야 한다**.
  * C#의 경우, 해당 코드 범위가 데이터 무결성을 필요로 한다는 것을 나타내기 위해 트랜잭션 범위 기능을 제공한다.
  * **Java의 경우, @Transactional과 같은 AOP 기반 어노테이션이 제공**된다.
    * 해당 어노테이션을 메소드에 추가하는 것으로 트랜잭션 범위와 같은 기능을 제공받을 수 있다. 
    * 메소드의 정상 종료시 커밋을 실행하는 반면, 메소드 실행 중 예외가 발생한 경우에는 롤백을 실행한다.
  * 이렇듯 언어마다 트랜잭션 범위와 유사한 기능을 제공하는 기능들이 존재하므로, 자신의 언어에 맞는 방식을 찾아 사용하는 것이 바람직하다.
* 트랜잭션 범위 또는 @Transactional 어노테이션 등은 즉각적으로 실제 트랜잭션을 시작하지는 않는다.
  * 그러나 **해당 기능이 명시된 범위 안에서 데이터베이스 커넥션이 새로 열리는 경우, 트랜잭션을 함께 시작하는 식으로 동작**한다.

### 유닛 오브 워크 패턴
* 어떠한 객체의 변경 사항을 기록하는 객체를 사용하는 유닛 오브 워크 패턴 역시 트랜잭션을 다루기 위한 목적으로 사용할 수 있다.
* 유닛 오브 워크 패턴을 적용한 경우, 대상 객체가 변경되었더라도 유닛 오브 워크 객체가 이를 모르는 상태에서는 데이터 저장소에 객체의 변화를 반영하지 않는다.
  * 커밋을 호출해야 그 때까지의 변경 사항을 데이터 저장소에 반영한다.
  * 해당 패턴을 적용한 경우, 객체의 생성, 변경, 삭제 등의 모든 동작이 유닛 오브 워크 객체를 통하게 된다.
* 이렇듯 트랜잭션을 활용하기 위해 사용할 수 있는 트랜잭션 범위, AOP, 유닛 오브 워크 패턴 등 다양한 패턴이 존재한다.
  * **가능하다면 선언적으로 사용 가능한 트랜잭션 범위 또는 AOP 방식을 선택하되, 이에 준하는 수단이 없는 경우 직접 구현하는 것이 바람직**하다.

### 트랜잭션으로 인한 락
* **데이터베이스가 제공하는 트랜잭션은 일관성 유지를 위해 데이터에 락을 걸며, 트랜잭션을 사용하는 경우에는 락의 범위를 항상 고려**해야 한다.
* **트랜잭션으로 인한 락의 범위는 최소한으로 유지되어야 하며, 락의 범위가 너무 넓어지면 그에 비례하여 처리의 실패 가능성도 높아진다**.
* **락의 범위를 최소화하기 위해 1개의 트랜잭션으로 저장하는 객체의 수를 하나로 제한하고, 객체의 크기를 가능한 한 줄이는 방법을 활용**할 수 있다.