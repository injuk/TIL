# EffectiveCodes
## 2022-03-17 Thu

## 직렬화
* 객체 직렬화란, Java 객체를 바이트 스트림으로 인코딩하는 직렬화와 바이트 스트림을 다시 객체로 구성하는 역직렬화 메커니즘이다.
* 직렬화된 객체는 다른 VM에 전송하거나, 디스크에 저장해둔 후 필요한 시점에 다시 역직렬화할 수 있다.

### 직렬화의 대안을 찾기
* 직렬화는 근본적으로 위험성이 큰 기능이다.
* 직렬화의 근본적인 문제는 공격 범위가 너무 넓고, 지속적으로 넓어져 방어하기 어렵다는 사실이다.
* 아주 신중하게 작성한 바이트 스트림만을 역직렬화해야 한다.
  * 신뢰할 수 없는 바이트 스트림을 역직렬화하는 일 자체가 공격에 노출되는 행위이다.
* **직렬화 위험을 피하는 가장 좋은 방법은 아무것도 역직렬화하지 않는 것**이다.
* **새로 작성하는 시스템에서 Java 직렬화를 사용해야할 이유는 전혀 없다**.
  * 해당 기능이 필요한 경우, 객체와 바이트 시퀀스를 변환해주는 다른 메커니즘을 사용하도록 한다.
  * **이러한 메커니즘의 선두주자로는 JSON, 프로토콜 버퍼 등이 있다**.
* **레거시 코드 등의 문제로 직렬화를 완전히 배제할 수 없다면, 신뢰할 수 없는 데이터를 절대 역직렬화하지 않아야 한다**.
* 직렬화를 반드시 사용해야 하고, 역직렬화한 데이터가 안전한지 확신할 수 없다면 객체 역직렬화 필터링 기능을 사용한다.
  * 해당 기능은 Java 9에서 도입되었으며, 데이터 스트림이 역직렬화되기 전에 필터를 설치하여 특정 클래스를 수용하거나 거부할 수 있다.
  * 객체 역직렬화 필터링은 화이트리스트 방식을 사용하는 기본 거부 모드로 사용하는 것이 바람직하다.
  * 객체 역직렬화 필터링으로도 객체 직렬화를 악용하는 모든 공격을 막아낼 수는 없다.
* 레거시 코드로부터 객체 직렬화를 사용하고 있다면, 시간과 노력을 들어서라도 JSON, 프로토콜 버퍼로의 전환을 고민해야 한다.

### 직렬화의 결론
* 직렬화는 위험하니 사용을 지양해야 하며, 시스템을 처음부터 설계한다면 JSON이나 프로토콜 버퍼를 고려한다.
* 신뢰할 수 없는 데이터는 절대로 역직렬화하지 말아야 한다.
* 반드시 역직렬화를 해야 한다면 객체 역직렬화 필터링을 사용하되, 이조차도 모든 공격을 방어할 수는 없다는 점을 명심한다.

### Serializable 구현은 신중하게 결정하기
* **어떤 클래스가 객체 직렬화를 지원하도록 하려면 Serializable 인터페이스만 구현하면 되지만, 직렬화 클래스를 지원하는 것은 훨씬 복잡한 일**이다.
* Serializable 인터페이스를 구현한 클래스는 다음과 같은 문제점이 발생할 수 있다.
  1. 릴리즈한 이후에는 최초의 내부 구현 방식이 고정되어 수정이 어려워진다.
     * 직렬화 가능한 클래스를 만들어야 한다면, 장기적인 안목으로 감당할 수 있을 만큼 좋은 품질을 갖는 직렬화 형태도 함께 설계해야 한다.
  2. 버그와 보안 구멍이 생길 위험성이 높아진다.
  3. 해당 클래스의 새로운 버전을 릴리즈할 때마다 테스트 양이 늘어난다.
* Serializable 인터페이스의 구현 여부는 쉽게 결정할 내용이 아니다.
* 상속용으로 설계된 클래스와 인터페이스는 대부분 Serializable 인터페이스를 구현하지 말아야 한다.
  * 이는 반드시 지켜야할 원칙은 아니다.
    * 예를 들어 상속용 클래스에서 직렬화를 지원하지 않는 경우, 하위 클래스에서 직렬화를 지원하게 만들기 위한 부담도 늘어난다.
  * 이를 위배하는 경우, 클래스를 확장하거나 인터페이스를 구현하는 클래스 작성자에게 큰 부담을 주게 된다.
* 내부 클래스는 Serializable 인터페이스를 구현하지 말아야 한다.

### Serializable 구현의 결론
* Serializable 인터페이스의 구현은 쉽지만, 장기적으로 사용될 수 있도록 하는 것은 매우 어렵다.
* 임의의 클래스가 여러 버전이 상호작용 될 일이 없고, 서버가 신뢰할 수 없는 데이터에 노출될 가능성이 없는 등 보호된 환경에서 사용될 클래스만 구현하도록 한다.
* 그렇지 않은 경우의 Serializable 인터페이스 구현은 아주 신중하게 진행되어야 하며, 상속 가능한 클래스라면 주의사항이 더욱 많아진다.