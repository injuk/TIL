# Spring MVC II
## 2024-08-03 Sat
### 적절한 오류 페이지 노출시키기
* 서블릿 컨테이너가 기본적으로 제공하는 오류 화면은 사용자 친화적이지 않으므로, 일반적으로는 자체적인 오류 화면을 제작하여 사용자에게 노출시키게 된다.
  * 이러한 기능은 서블릿 차원에서 가능하며, `Exception`이 감지된 경우와 `response.sendError();`가 호출된 경우 각각에 대한 처리 기능을 제공한다.
```java
@Component
public class WebServerCustomizer implements WebServerFactoryCustomizer<ConfigurableWebServerFactory> {
    @Override
    public void customize(ConfigurableWebServerFactory factory) {
        // response.sendError([오류코드]); 호출에 대응된다.
        ErrorPage errorPage404 = new ErrorPage(HttpStatus.NOT_FOUND, "/error-page/404");
        ErrorPage errorPage500 = new ErrorPage(HttpStatus.INTERNAL_SERVER_ERROR, "/error-page/500");
      
        // 아래 설정은 Exception이 전파된 경우에 대응되며, RuntimeException 및 그 자식 예외들을 모두 포함한다.
        ErrorPage errorPageEx = new ErrorPage(RuntimeException.class, "/error-page/500");
        
        factory.addErrorPages(errorPage404, errorPage500, errorPageEx);
    }
} 
```
* **상술한 방식은 오류가 발생한 경우 대응되는 오류 페이지를 `ErrorPage` 클래스로 표현하며, 이를 제공하는 별도의 컨트롤러가 준비되었음을 전제**한다.
  * 즉, 위 예시의 경우 `/error-page/404` 등에 대해 동작하는 `@Controller` 클래스가 작성되어 있어야 의도한 대로 동작할 수 있다.
  * 이렇듯 **컨트롤러를 활용하는 특성상, WAS는 오류를 인지한 경우 `ErrorPage`를 위해 필터와 인터셉터를 통하는 호출 흐름을 다시 만들어낸다**.
* 이러한 **`WebServerFactoryCustomizer`가 스프링 부트의 빈으로 등록된 경우, 스프링 부트가 실행되는 과정에서 각 오류 페이지를 톰캣에 등록**한다.

## 2024-08-04 Sun
### WAS의 오류 페이지 노출 흐름
```
> WAS는 웹 애플리케이션 내부에서 발생한 오류 상태를 인식한 경우, 등록된 오류 페이지를 찾아 해당 오류 페이지를 호출하는 요청 흐름을 만들어 처리한다.
> 이러한 요청 흐름은 사실상 내부적인 처리를 위해 새로운 HTTP 요청을 생성하는 것과 동일하므로, 필터와 인터셉터를 다시 한 번 거치게 된다.
```
* `response.sendError();` 메소드를 예로 들어, 사용자의 요청에 대해 WAS가 이를 처리하는 흐름은 다음과 같이 정리할 수 있다.
```
1. 사용자의 요청 > WAS > 필터 > 서블릿 > 인터셉터 > 컨트롤러
2. 컨트롤러 상 response.sendError(); 메소드 호출 > 인터셉터 > 서블릿 > 필터 > WAS > response에 기록된 오류 상태 확인
3. 오류 처리를 위한 WAS의 /error-page/500 요청 > 필터 > 서블릿 > 인터셉터 > 컨트롤러 > 오류 처리를 위한 View 
```
* 이 때, **WAS 내부적으로는 마치 HTTP 요청이 다시 발생한 것처럼 처리하지만 사용자의 웹 브라우저 차원에서는 이러한 내부적인 동작을 인지하지 못한다**.
  * 즉, **이러한 요청 흐름은 오직 서버 내부적으로만 발생하는 추가적인 호출에 해당**한다.

## 2024-08-05 Mon
### 예외 처리와 서블릿 필터
* 상술했듯, WAS는 오류를 인지했을 경우 오류 처리 페이지를 호출하는 새로운 요청 흐름을 만들어낸다.
  * 그러나 로그인 관심사를 처리하는 필터나 인터셉터를 예로 들어, 이미 처리된 필터 및 인터셉터 로직을 다시 처리하는 것은 비효율적인 일에 해당한다.
  * 즉, **클라이언트로부터 발생한 정상 요청인지 또는 WAS에 의해 내부적으로 발생한 오류 처리 로직인지 구분할 필요**가 있다.
  * 무엇보다, 애당초 하나의 요청을 처리하는 과정에서 중복으로 처리되지 않아야 하는 필터도 있을 수 있다.
* **서블릿은 사용자에 의한 요청 흐름과 WAS에 의한 새로운 요청 흐름을 구분하기 위해 다음과 같이 `DispatcherType`이라는 추가 정보를 제공**한다.
  1. `REQUEST`: 사용자에 의한 실제 요청을 의미한다.
  2. `ERROR`: WAS의 오류 처리 과정에서 발생한 새로운 요청 흐름을 의미한다.
  3. `FORWARD`: 다른 서블릿이나 JSP로부터 `RequestDispatcher.forward(request, response);`로 호출된 경우를 의미한다.
  4. `INCLUDE`: 다른 서블릿이나 JSP의 결과를 `RequestDispatcher.include(request, response);`로 포함하는 경우를 의미한다.
  5. `ASYNC`: 서블릿의 비동기 호출을 의미한다.
* 필터의 경우, 다음과 같은 설정을 통해 각 필터가 어떠한 `DispatcherType`에 대해 동작할지 명시할 수 있다.
  * 이 때, **`setDispatcherTypes();` 메소드를 호출하지 않는 경우 기본 값은 오로지 `REQUEST` 타입의 요청에 대해서만 동작하는 필터로 설정**된다.
```java
@Configuration
public class WebConfig {

    @Bean
    public FilterRegistrationBean logFilter() {
        FilterRegistrationBean<Filter> filterRegistrationBean = new FilterRegistrationBean<>();
        filterRegistrationBean.setFilter(new LogFilter());
        filterRegistrationBean.setOrder(1);
        filterRegistrationBean.addUrlPatterns("/*");
      
        // DispatcherType이 REQUEST이거나 ERROR인 요청에 대해 동작한다.
        filterRegistrationBean.setDispatcherTypes(DispatcherType.REQUEST, DispatcherType.ERROR);

        return filterRegistrationBean;
    }
}
```

## 2024-08-06 Tue
### 예외 처리와 스프링 인터셉터
```
> DispatcherType을 통해 중복 호출을 제거하는 서블릿 필터와 달리, 스프링 인터셉터는 경로 정보를 토대로 excludePathPatterns() 메소드를 활용한다.
```
* 상술한 서블릿 필터의 경우, 서블릿에 종속된 기술인 반면 인터셉터는 스프링이 제공하는 기술이기에 오류 처리에 있어 다른 방식을 적용해야 한다.
  * 자세히 말해 인터셉터를 등록할 경우, 스프링 인터셉터가 제공하는 강력한 기능인 `excludePathPatterns();` 메소드를 활용한다.
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LogInterceptor())
                .order(1)
                .addPathPatterns("/**")
                .excludePathPatterns("/error-page/**"); // 오류 처리 페이지에 대해서는 모두 제외한다.
    }
}
```