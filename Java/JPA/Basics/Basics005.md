# Basics
## 2022-07-19 Tue

### 연관 관계 매핑 시 주의사항
* 연관 관계를 매핑하는 경우, 크게 다음과 같은 항목을 주의해야 한다.
  1. 다중성
  2. 단방향과 양방향
  3. 연관 관계의 주인

### 다중성
* 다중성이란, 매핑되는 두 엔티티 간의 비율을 의미하며 다음과 같이 구분된다.
  1. @ManyToOne
  2. @OneToMany
  3. @OneToOne
  4. @ManyToMany
* **JPA가 제공하는 모든 어노테이션은 실제 데이터베이스와 매핑하기 위한 기능이므로, 다중성 어노테이션 역시 같은 용도로 사용**된다.
  * 때문에 다중성 역시 데이터베이스 관점에서 고려되어야 하며, 어떤 다중성을 선택할지 확신되지 않는 경우에는 두 엔티티의 관계를 뒤집어 생각해본다.
  * 다중성은 대칭을 이루므로, 엔티티의 관계가 1:N이라면 두 엔티티를 바꾸어 생각해보았을 때 N:1 관계가 되어야 한다.
* 이 때, **실무에서는 M:N 관계를 의미하는 @ManyToMany의 사용을 지양하는 것이 바람직**하다.
  * 주로 @ManyToOne이 사용되며, 뒤이어 @OneToMany와 @OneToOne이 사용된다.

### 방향성
* 앞서 다룬 바와 같이, 관계형 데이터베이스의 테이블 구조는 FK만으로도 양방향 모두 JOIN 연산이 가능하다.
  * 즉, 근본적으로 방향성이라는 개념을 둘 필요가 없다.
* 반면 객체는 참조가 존재하는 필드 방향으로만 탐색이 가능하며, 이러한 참조의 존재 여부에 따라 단방향과 양방향 관계가 결정된다.
  * 엄밀히 말하자면 객체는 두 개의 단방향 연관 관계를 통해 양방향 연관 관계를 구성한다.

### 연관 관계의 주인
* 테이블은 FK 하나로 두 테이블이 연관 관계를 맺지만, 객체는 양방향 관계를 위한 참조가 각각 하나씩 존재해야 한다.
* 즉, **객체의 참조는 둘이지만 테이블의 FK는 하나이므로 둘 중 FK를 관리하기 위한 주체가 될 참조를 선정할 필요**가 있다.
  * 이 떄, 연관 관계의 주인은 FK를 관리하는 참조를 의미한다.
  * 연관 관계의 주인이 아닌 참조는 FK의 관리에 전혀 영향을 주지 못하며, 오직 읽기 동작만이 가능하다.

### 다대 일 연관 관계
* **다대 일 연관 관계는 JPA에서 가장 자주 사용되며, 그만큼 중요한 연관 관계**이다.
  * 해당 연관 관계의 반대는 일대 다 연관 관계가 된다.
* 데이터베이스 설계 상, 다대 일 관계에서 FK는 항상 다 측의 테이블에 위치하게 된다.
  * 그렇지 못한 경우, 데이터베이스 설계가 잘못 된 것으로 이해할 수 있다.
* **다대 일 연관 관계의 수립 역시 FK가 존재하는 측의 엔티티에 참조를 정의한 후 연관 관계를 매핑하는 것으로 완료**된다.
* **다대 일 단방향 연관 관계를 적절히 수립해둔 경우, 추후 필요에 의해 양방향 연관 관계로 수정하더라도 테이블에는 아무런 영향을 주지 않는다**.
  * 이는 다대 일 단방향 연관 관계를 수립하는 과정에서 FK를 관리할 연관 관계의 주인이 이미 선정되었기 때문이다.
  * **반대 방향 연관 관계를 수립한다고 해도, 해당 연관 관계를 시작하는 엔티티는 연관 관계의 주인이 아니므로 FK에 영향을 줄 수 없다**.
  * 무엇보다, 반대 방향 연관 관계에서는 읽기 동작만이 가능하다.
* **연관 관계의 주인이 아닌 측은 `@OneToMany(mappedBy = "필드명")`과 같은 형태로 상대 편 엔티티의 필드에 의해 연관 관계가 매핑되었음을 명시**한다.
* 이렇듯 다대 일 양방향 연관 관계의 경우, 다음과 같은 조건을 충족하도록 구현되어야 한다.
  1. **FK가 있는 측 엔티티가 연관 관계의 주인**이 된다.
  2. 양 쪽 엔티티가 서로를 참조할 수 있도록 참조용 필드를 제공하여 구현한다.

### 일대 다 연관 관계
* 해당 연관 관계의 경우, 1인 측의 엔티티가 연관 관계의 주인이 되어 FK를 관리하게 된다.
  * 그러나 해당 연관 관계는 실무에서는 권장되지 않는 방식이기도 하다.
* 이는 상술한 시나리오에서, 마치 회원은 팀 정보에 접근할 필요가 없지만 팀은 회원 정보를 알아야하기에 연관 관계의 주인이 되는 경우에 해당한다.
* 그러나 **중요한 것은, 객체 사이의 관계는 이러한 연관 관계를 허용하지만 데이터베이스 상의 FK는 반드시 N 측의 엔티티에 포함되어야 한다는 사실**이다.
  * 이는 사실상 하나의 법칙으로 이해해도 무방하다.
* 결국 **이러한 방식은 마치 팀 객체에 포함된 회원 목록을 수정하지만 실제로는 회원 테이블의 FK가 수정되는 부자연스러운 시나리오를 갖게 된다**.
  * 이렇듯 일대 다 단방향 연관 관계의 경우, 객체와 테이블의 차이로 인해 연관 관계의 주인 엔티티 객체가 반대 편 엔티티의 테이블을 관리하는 구조를 갖게 된다.
* **이러한 방식은 @JoinColumn 어노테이션이 필수적으로 명시되어야 하며, 이를 원치 않을 경우에는 별도의 테이블을 두는 조인 테이블 방식을 사용**해야 한다.
  * 정확히는 @JoinColumn을 명시하지 않는 경우, 자동으로 조인을 위한 중간 테이블이 생성된다.
  * 이렇듯 중간 테이블이 생성되는 방식은 굳이 새로운 테이블을 생성하므로, 장기적인 유지보수성과 성능 상의 단점을 가질 수 밖에 없다.
  * 반면 @JoinColumn 어노테이션을 추가하는 경우를 예를 들어, 아래와 같은 부자연스러운 코드의 작성이 필수적이다.
```
@OneToMany
@JoinColumn(name = "team_id")
private List<Members> members = new ArrayList<>();
```
* **이 경우, 팀 엔티티에 회원을 추가하여 em.persist 등을 통해 데이터를 영속화할 경우 회원 테이블의 FK를 수정하기 위한 UPDATE 쿼리가 요청**된다.

### 일대 다 단방향 연관 관계의 단점
* 추가적인 UPDATE 쿼리 요청으로 인한 성능 상의 단점은 당연히 존재하지만, 이는 크게 체감될 정도의 문제는 되지 않곤 한다.
* 해당 방식이 정말 **문제가 되는 것은 애플리케이션 개발 과정에서 개발자가 예측하기 어려운, 옆 테이블에 대한 UPDATE 쿼리가 요청된다는 점**이다. 
  * 이는 JPA를 처음 사용하는 사람에게도 불편함을 주지만, JPA 숙련자조차 수십 개의 테이블이 상호작용하는 환경 속에서 운영을 어렵게 만드는 요인이 된다.
* 이러한 **단점은 모두 연관 관계의 주인인 엔티티가 관리해야 할 FK가 다른 테이블에 위치하기 때문으로, 이로 인해 불필요한 UPDATE 쿼리가 요청되는 것**이다.
* **가장 이상적인 것은 N:1 연관 관계를 기본으로 채택하되, 필요한 경우에 양방향 연관 관계를 추가하는 전략을 사용하는 것**이다.
  * **이러한 방식은 불필요한 객체 참조가 추가되므로 객체 지향적으로는 아쉬움이 있지만, 대신 전체적인 유지보수성을 끌어올리는 tradeoff에 해당**한다.
* **극단적으로는 처음부터 다대 일 단방향 연관 관계를 사용하는 것이 바람직하며, 다대 일 단방향 / 양방향 연관 관계를 적절히 활용하는 것**이다.
  * 이 경우 많은 문제가 깔끔하게 해결되며, 일대 다 연관 관계에 대해서 알 필요조차 없어진다.

### 일대 다 양방향 연관 관계?
* 이러한 연관 관계는 JPA의 스펙 상으로는 공식적으로 존재하지 않지만, 우회적인 방법을 사용하여 유사한 효과를 얻을 수 있다.
```
@ManyToOne
@JoinColumn(name = "team_id", insertable = "false", updatable = "false")
private Team team;
```
* 상술한 방식은 읽기 전용 필드를 추가하여 마치 양방향 연관 관계가 설정된 것처럼 사용하는 방식이다.
  * 이 때, insertable, updatable 속성을 명시하지 않는 경우 양방향 연관 관계를 설정한 모든 엔티티가 연관 관계의 주인처럼 동작한다.
  * 심지어 이러한 경우 하이버네이트는 오류를 발생시키지도 않으므로 큰 위험성이 수반될 수 있다.
  * 반면, 이렇듯 읽기 전용 필드로 설정하는 방식은 실무 환경이 복잡해짐에 따라 간혹 사용될 수도 있는 방식이다.
* **공식적으로 지원하지 않는 방식인 만큼 당연히 바람직한 접근은 아니며, 필요한 경우에는 다대 일 양방향 연관 관계를 사용**하도록 한다.
  * 즉, 일대 다 단방향 또는 양방향 연관 관계를 억지로 설정하는 것보다는 다대 일 연관 관계를 선택하는 것이 바람직하다.
  * 실무에서 테이블이 많아지고 환경이 복잡해질수록, 단순하고 누구나 이해할 수 있는 직관적인 설계와 매핑은 큰 빛을 발한다.