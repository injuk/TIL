# Basics
## 2022-07-19 Tue

### 연관 관계 매핑 시 주의사항
* 연관 관계를 매핑하는 경우, 크게 다음과 같은 항목을 주의해야 한다.
  1. 다중성
  2. 단방향과 양방향
  3. 연관 관계의 주인

### 다중성
* 다중성이란, 매핑되는 두 엔티티 간의 비율을 의미하며 다음과 같이 구분된다.
  1. @ManyToOne
  2. @OneToMany
  3. @OneToOne
  4. @ManyToMany
* **JPA가 제공하는 모든 어노테이션은 실제 데이터베이스와 매핑하기 위한 기능이므로, 다중성 어노테이션 역시 같은 용도로 사용**된다.
  * 때문에 다중성 역시 데이터베이스 관점에서 고려되어야 하며, 어떤 다중성을 선택할지 확신되지 않는 경우에는 두 엔티티의 관계를 뒤집어 생각해본다.
  * 다중성은 대칭을 이루므로, 엔티티의 관계가 1:N이라면 두 엔티티를 바꾸어 생각해보았을 때 N:1 관계가 되어야 한다.
* 이 때, **실무에서는 M:N 관계를 의미하는 @ManyToMany의 사용을 지양하는 것이 바람직**하다.
  * 주로 @ManyToOne이 사용되며, 뒤이어 @OneToMany와 @OneToOne이 사용된다.

### 방향성
* 앞서 다룬 바와 같이, 관계형 데이터베이스의 테이블 구조는 FK만으로도 양방향 모두 JOIN 연산이 가능하다.
  * 즉, 근본적으로 방향성이라는 개념을 둘 필요가 없다.
* 반면 객체는 참조가 존재하는 필드 방향으로만 탐색이 가능하며, 이러한 참조의 존재 여부에 따라 단방향과 양방향 관계가 결정된다.
  * 엄밀히 말하자면 객체는 두 개의 단방향 연관 관계를 통해 양방향 연관 관계를 구성한다.

### 연관 관계의 주인
* 테이블은 FK 하나로 두 테이블이 연관 관계를 맺지만, 객체는 양방향 관계를 위한 참조가 각각 하나씩 존재해야 한다.
* 즉, **객체의 참조는 둘이지만 테이블의 FK는 하나이므로 둘 중 FK를 관리하기 위한 주체가 될 참조를 선정할 필요**가 있다.
  * 이 떄, 연관 관계의 주인은 FK를 관리하는 참조를 의미한다.
  * 연관 관계의 주인이 아닌 참조는 FK의 관리에 전혀 영향을 주지 못하며, 오직 읽기 동작만이 가능하다.

### 다대 일 연관 관계
* **다대 일 연관 관계는 JPA에서 가장 자주 사용되며, 그만큼 중요한 연관 관계**이다.
  * 해당 연관 관계의 반대는 일대 다 연관 관계가 된다.
* 데이터베이스 설계 상, 다대 일 관계에서 FK는 항상 다 측의 테이블에 위치하게 된다.
  * 그렇지 못한 경우, 데이터베이스 설계가 잘못 된 것으로 이해할 수 있다.
* **다대 일 연관 관계의 수립 역시 FK가 존재하는 측의 엔티티에 참조를 정의한 후 연관 관계를 매핑하는 것으로 완료**된다.
* **다대 일 단방향 연관 관계를 적절히 수립해둔 경우, 추후 필요에 의해 양방향 연관 관계로 수정하더라도 테이블에는 아무런 영향을 주지 않는다**.
  * 이는 다대 일 단방향 연관 관계를 수립하는 과정에서 FK를 관리할 연관 관계의 주인이 이미 선정되었기 때문이다.
  * **반대 방향 연관 관계를 수립한다고 해도, 해당 연관 관계를 시작하는 엔티티는 연관 관계의 주인이 아니므로 FK에 영향을 줄 수 없다**.
  * 무엇보다, 반대 방향 연관 관계에서는 읽기 동작만이 가능하다.
* **연관 관계의 주인이 아닌 측은 `@OneToMany(mappedBy = "필드명")`과 같은 형태로 상대 편 엔티티의 필드에 의해 연관 관계가 매핑되었음을 명시**한다.
* 이렇듯 다대 일 양방향 연관 관계의 경우, 다음과 같은 조건을 충족하도록 구현되어야 한다.
  1. **FK가 있는 측 엔티티가 연관 관계의 주인**이 된다.
  2. 양 쪽 엔티티가 서로를 참조할 수 있도록 참조용 필드를 제공하여 구현한다.