# Basics
## 2022-07-12 Tue

### JPA에서 중요한 개념들
* 올바른 JPA의 사용을 위해서 반드시 이해해야하는 것은 다음과 같다.
  1. 객체와 관계형 데이터베이스의 매핑
  2. 영속성 컨텍스트
* 객체와 관계형 데이터베이스의 매핑은 설계와 같은 정적인 지식을 필요로 하며, 크게 다음과 같이 분류할 수 있다.
  * 데이터베이스의 설계
  * 객체의 설계
  * JPA를 활용한 매핑
* 반면 **영속성 컨텍스트의 경우, 실제로 JPA는 내부적으로 어떻게 동작하는지에 대한 지식을 나타낸다**.
  * 때문에 영속성 컨텍스트를 명확히 이해할 경우, JPA의 내부 동작 원리를 알 수 있게 된다.

### 영속성 컨텍스트란?
* **영속성 컨텍스트란 엔티티를 영구 저장하는 환경을 의미하며, JPA를 이해하는 데에 있어 가장 중요한 용어**이다.
* 앞서 다룬 **em.persiste(entity)의 경우, 실제로는 데이터베이스에 즉시 영속화하는 것이 아닌 영속성 컨텍스트에 저장하는 것**이다.
* **영속성 컨텍스트는 논리적인 개념이며, 개발자는 엔티티 매니저를 통해서만 영속성 컨텍스트에 접근**할 수 있다.
  * 엔티티 매니저가 내부적으로 영속성 컨텍스트라는 공간을 포함하는 것으로 이해해도 무방하다.

### 엔티티 생명주기
* 엔티티는 영속성 컨텍스트와 밀접한 연관이 있으며, 다음과 같이 분류되는 상태를 가질 수 있다.
  1. 비영속 상태: 영속성 컨텍스트와 전혀 관계 없는 새로운 상태이다.
  2. 영속 상태: 영속성 컨텍스트에 의해 관리되는 상태이다.
  3. 준영속 상태: 영속성 컨텍스트에 저장되었으나, 현재에는 분리된 상태이다.
  4. 삭제 상태: 말 그대로 삭제된 상태를 말한다.

### 비영속 상태
* 비영속 상태란, 엔티티 객체가 new 연산자 등에 의해 막 생성된 상태일 수 있다.
* 비영속 엔티티는 엔티티 매니저에 포함되는 영속성 컨텍스트와는 완전히 무관한 상태를 갖는다.
  * 즉, **비영속 상태의 엔티티는 JPA와는 전혀 관계가 없다**.

### 영속 상태
* **비영속 상태의 엔티티 객체를 em.persist 등의 메소드를 통해 영속성 컨텍스트에 저장한 상황**을 가리킨다. 
  * **영속 상태의 엔티티는 영속성 컨텍스트에 의해 관리**된다.
* **중요한 것은 영속 상태에 진입한 엔티티는 그 즉시 데이터베이스에 저장되지는 않는다는 사실**이다.
  * 즉, 엔티티가 영속 상태가 된다고 해서 즉시 데이터베이스에 쿼리를 요청하지는 않는다.
  * **실제 쿼리는 트랜잭션을 커밋하는 시점에 영속성 컨텍스트에 의해 관리되던 엔티티 객체들의 상태에 따라 쿼리가 요청**된다.

### 준영속 상태와 삭제 상태
* 준영속 상태란 em.detach 등의 메소드에 의해 엔티티가 영속성 컨텍스트에서 분리된 상태를 의미한다.
* 삭제 상태란 em.remove 등의 메소드에 의해 객체가 삭제된 상태를 의미한다.
  * 이 때, 해당 메소드는 실제로 데이터베이스에 영속화된 데이터에 대해 DELETE 쿼리를 요청한다.

### 영속성 컨텍스트의 이점
* 영속성 컨텍스트와 같은 메커니즘은 개발자에게 다음과 같은 이점을 제공한다.
  1. 1차 캐시를 제공한다.
  2. 엔티티의 동일성을 보장한다.
  3. 트랜잭션을 지원하는 쓰기 지연 기능을 제공한다.
  4. 변경 감지 기능을 제공한다.
  5. 지연 로딩 기능을 제공한다.
* 이는 모두 **애플리케이션과 데이터베이스 사이에 영속성 컨텍스트가 마치 버퍼처럼 중간 계층으로 존재함으로써 제공되는 이점**이다.